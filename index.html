<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AR Web (A-Frame + MindAR)</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <!-- MindAR (image tracking for A-Frame) -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background:#000; font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; }
    #hud {
      position: fixed; left: 0; right: 0; top: 0;
      padding: 10px 12px; color: #fff; z-index: 10;
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0));
      pointer-events: none; font-size: 14px; line-height: 1.35;
    }
    #loading, #scanning {
      position: fixed; inset: 0; z-index: 20;
      display: flex; align-items: center; justify-content: center;
      color: #fff; text-align: center;
      background: rgba(0,0,0,.55);
    }
    #loading.hidden, #scanning.hidden { display: none; }
    .panel { padding: 14px 16px; border-radius: 12px; background: rgba(0,0,0,.55); max-width: 340px; }
    .hint {
      position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 10;
      color: #fff; background: rgba(0,0,0,.45);
      padding: 10px 12px; border-radius: 12px;
      font-size: 13px; pointer-events: none;
    }
  </style>

  <script>
    // 1 палец — перемещение, 2 пальца — масштаб + поворот
    AFRAME.registerComponent('touch-manipulate', {
      schema: { minScale: {default: 0.25}, maxScale: {default: 2.5}, moveFactor: {default: 0.0018} },

      init: function () {
        this.active = false;

        this.startPos = new THREE.Vector3();
        this.startRotY = 0;
        this.startScale = new THREE.Vector3();

        this.t1 = {x:0,y:0};
        this.t2 = {x:0,y:0};
        this.startDist = 0;
        this.startAngle = 0;
        this.mode = null; // 'one' | 'two'

        // Тап по модели — включить/выключить управление
        this.el.addEventListener('click', () => {
          this.active = !this.active;
          document.getElementById('state').textContent =
            this.active ? 'Объект выбран (жесты активны)' : 'Объект не выбран';

          this.el.setAttribute('animation__pulse', this.active
            ? 'property: scale; to: 1.06 1.06 1.06; dur: 120; dir: alternate; loop: 2; easing: easeOutQuad'
            : 'property: scale; to: 1 1 1; dur: 0'
          );
        });

        // Ловим touch на canvas (на мобильных это надёжнее)
        const sceneEl = this.el.sceneEl;
        sceneEl.addEventListener('renderstart', () => {
          const canvas = sceneEl.canvas;
          canvas.style.touchAction = 'none';

          canvas.addEventListener('touchstart', this.onStart.bind(this), {passive:false});
          canvas.addEventListener('touchmove',  this.onMove.bind(this),  {passive:false});
          canvas.addEventListener('touchend',   this.onEnd.bind(this),   {passive:false});
          canvas.addEventListener('touchcancel',this.onEnd.bind(this),   {passive:false});
        });
      },

      onStart: function (e) {
        if (!this.active || !e.touches || e.touches.length === 0) return;
        e.preventDefault();

        this.startPos.copy(this.el.object3D.position);
        this.startRotY = this.el.object3D.rotation.y;
        this.startScale.copy(this.el.object3D.scale);

        if (e.touches.length === 1) {
          this.mode = 'one';
          this.t1.x = e.touches[0].clientX;
          this.t1.y = e.touches[0].clientY;

        } else if (e.touches.length >= 2) {
          this.mode = 'two';
          this.t1.x = e.touches[0].clientX; this.t1.y = e.touches[0].clientY;
          this.t2.x = e.touches[1].clientX; this.t2.y = e.touches[1].clientY;

          const dx = this.t2.x - this.t1.x;
          const dy = this.t2.y - this.t1.y;
          this.startDist = Math.hypot(dx, dy);
          this.startAngle = Math.atan2(dy, dx);
        }
      },

      onMove: function (e) {
        if (!this.active || !this.mode || !e.touches || e.touches.length === 0) return;
        e.preventDefault();

        if (this.mode === 'one' && e.touches.length === 1) {
          const x = e.touches[0].clientX;
          const y = e.touches[0].clientY;
          const dx = x - this.t1.x;
          const dy = y - this.t1.y;

          // Движение по плоскости маркера: X и Z
          const nx = this.startPos.x + dx * this.data.moveFactor;
          const nz = this.startPos.z + (-dy) * this.data.moveFactor;
          this.el.object3D.position.set(nx, this.startPos.y, nz);

        } else if (this.mode === 'two' && e.touches.length >= 2) {
          const x1 = e.touches[0].clientX, y1 = e.touches[0].clientY;
          const x2 = e.touches[1].clientX, y2 = e.touches[1].clientY;

          const dx = x2 - x1;
          const dy = y2 - y1;
          const dist = Math.hypot(dx, dy);
          const angle = Math.atan2(dy, dx);

          // Масштаб
          const k = dist / (this.startDist || dist);
          const raw = this.startScale.x * k;
          const s = THREE.MathUtils.clamp(raw, this.data.minScale, this.data.maxScale);
          this.el.object3D.scale.set(s, s, s);

          // Поворот вокруг Y
          const dA = angle - this.startAngle;
          this.el.object3D.rotation.y = this.startRotY + dA;
        }
      },

      onEnd: function () { this.mode = null; }
    });

    window.addEventListener('DOMContentLoaded', () => {
      const loading = document.getElementById('loading');
      const scanning = document.getElementById('scanning');
      const sceneEl = document.querySelector('a-scene');

      sceneEl.addEventListener('arReady', () => {
        loading.classList.add('hidden');
        scanning.classList.remove('hidden');
      });

      sceneEl.addEventListener('arError', () => {
        loading.classList.remove('hidden');
        loading.querySelector('.panel').innerHTML =
          '<b>Ошибка запуска AR</b><br/>Проверь камеру и открой в Safari.';
      });
    });
  </script>
</head>

<body>
  <div id="hud">
    <div><b>AR Web (A-Frame + MindAR)</b></div>
    <div id="state">Объект не выбран</div>
  </div>

  <div id="loading">
    <div class="panel">
      <b>Загрузка AR…</b><br/>Разреши доступ к камере (Allow).
    </div>
  </div>

  <div id="scanning" class="hidden">
    <div class="panel">
      <b>Наведите камеру на маркер</b><br/>Держите маркер в кадре 1–2 секунды.
    </div>
  </div>

  <div class="hint">
    Тап по модели — выбрать/снять выбор • 1 палец — двигать • 2 пальца — масштаб + поворот
  </div>

  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; uiScanning: #scanning; uiLoading: #loading;"
    embedded
    background="transparent: true"
    renderer="alpha: true; colorManagement: true; physicallyCorrectLights: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-assets>
      <a-asset-item id="modelAsset" src="./model.glb"></a-asset-item>
    </a-assets>

    <!-- курсор нужен, чтобы клик/тап по модели работал -->
    <a-camera position="0 0 0"
      look-controls="enabled: false"
      cursor="rayOrigin: mouse"
      raycaster="objects: .clickable">
    </a-camera>

    <a-entity light="type: ambient; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="0 1 1"></a-entity>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-entity class="clickable"
        gltf-model="#modelAsset"
        position="0 0 0"
        rotation="0 0 0"
        scale="0.6 0.6 0.6"
        touch-manipulate>
      </a-entity>
    </a-entity>

  </a-scene>
</body>
</html>
