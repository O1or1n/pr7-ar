<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Ññ7 ‚Äî WebAR –Ω–∞ A-Frame (MindAR)</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    :root {
      --glass: rgba(0,0,0,.45);
      --glass2: rgba(0,0,0,.30);
      --stroke: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
    }

    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* –û–≤–µ—Ä–ª–µ–π: –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç –∂–µ—Å—Ç—ã –ø–æ —Å—Ü–µ–Ω–µ */
    #ui {
      position: fixed;
      inset: 0;
      z-index: 10;
      pointer-events: none;
      color: var(--text);

      /* Safe-area –¥–ª—è iPhone */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);

      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 14px;
    }

    /* –í–µ—Ä—Ö–Ω—è—è –ø–ª–∞—à–∫–∞ */
    #topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 14px 0 14px;
    }

    #title {
      display: grid;
      gap: 2px;
    }
    #title b { font-size: 14px; letter-spacing: .2px; }
    #title span { font-size: 12px; color: var(--muted); }

    #statusPill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: var(--glass);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      font-size: 12px;
      color: var(--muted);
      max-width: 62vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,.35);
      box-shadow: 0 0 0 6px rgba(255,255,255,.06);
    }
    .dot.ok { background: rgba(120, 255, 180, .85); box-shadow: 0 0 0 6px rgba(120, 255, 180, .12); }
    .dot.bad { background: rgba(255, 180, 120, .85); box-shadow: 0 0 0 6px rgba(255, 180, 120, .12); }

    /* –¶–µ–Ω—Ç—Ä: ‚Äú–ø—Ä–∏—Ü–µ–ª‚Äù –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞ */
    #center {
      display: grid;
      place-items: center;
      padding: 0 14px;
    }

    #reticleWrap {
      width: min(70vw, 320px);
      aspect-ratio: 1 / 1;
      position: relative;
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid var(--stroke);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    /* ‚Äú—É–≥–æ–ª–∫–∏‚Äù —Ä–∞–º–∫–∏ */
    .corner {
      position: absolute;
      width: 34px; height: 34px;
      border: 2px solid rgba(255,255,255,.55);
      border-radius: 14px;
      opacity: .85;
    }
    .c1 { top: 10px; left: 10px; border-right: none; border-bottom: none; }
    .c2 { top: 10px; right: 10px; border-left: none; border-bottom: none; }
    .c3 { bottom: 10px; left: 10px; border-right: none; border-top: none; }
    .c4 { bottom: 10px; right: 10px; border-left: none; border-top: none; }

    /* ‚Äú—Å–∫–∞–Ω-–ª–∏–Ω–∏—è‚Äù */
    #scanLine {
      position: absolute;
      left: 12px; right: 12px;
      top: 16px;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(120,255,180,.9), transparent);
      opacity: .9;
      filter: drop-shadow(0 0 10px rgba(120,255,180,.35));
      animation: scan 2.2s ease-in-out infinite;
    }
    @keyframes scan {
      0%   { transform: translateY(0); opacity: .55; }
      50%  { transform: translateY(calc(min(70vw, 320px) - 60px)); opacity: 1; }
      100% { transform: translateY(0); opacity: .55; }
    }

    /* –ù–∏–∂–Ω—è—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
    #bottom {
      padding: 0 14px 14px 14px;
      display: grid;
      place-items: center;
    }

    #card {
      width: min(92vw, 560px);
      border-radius: 18px;
      padding: 12px 14px;
      background: var(--glass2);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    #card b { font-size: 13px; }
    #card .row {
      margin-top: 8px;
      display: grid;
      gap: 6px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .kbd {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      font-size: 12px;
      color: rgba(255,255,255,.82);
      transform: translateY(-1px);
    }

    /* –°–∫—Ä—ã–≤–∞–µ–º ‚Äú—Å–∫–∞–Ω-—Ä–∞–º–∫—É‚Äù –ø–æ—Å–ª–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è */
    #ui.found #reticleWrap { opacity: .25; }
    #ui.found #scanLine { opacity: .0; animation: none; }
  </style>
</head>

<body>
  <!-- UI –ø–æ–≤–µ—Ä—Ö –∫–∞–º–µ—Ä—ã/—Å—Ü–µ–Ω—ã -->
  <div id="ui">
    <div id="topbar">
      <div id="title">
        <b>WebAR –Ω–∞ A-Frame + MindAR</b>
        <span>–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Ññ7 ‚Ä¢ image tracking</span>
      </div>

      <div id="statusPill">
        <span id="dot" class="dot"></span>
        <span id="chip">–ñ–¥—ë–º –º–∞—Ä–∫–µ—Ä‚Ä¶</span>
      </div>
    </div>

    <div id="center">
      <div id="reticleWrap" aria-hidden="true">
        <div id="scanLine"></div>
        <div class="corner c1"></div>
        <div class="corner c2"></div>
        <div class="corner c3"></div>
        <div class="corner c4"></div>
      </div>
    </div>

    <div id="bottom">
      <div id="card">
        <b>–ö–∞–∫ —É–ø—Ä–∞–≤–ª—è—Ç—å –º–æ–¥–µ–ª—å—é</b>
        <div class="row">
          <div>üì∑ –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä –∏ –¥–µ—Ä–∂–∏ –µ–≥–æ –≤ —Ä–∞–º–∫–µ 1‚Äì2 —Å–µ–∫—É–Ω–¥—ã.</div>
          <div>‚òùÔ∏è <span class="kbd">1 –ø–∞–ª–µ—Ü</span> ‚Äî –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</div>
          <div>‚úåÔ∏è <span class="kbd">2 –ø–∞–ª—å—Ü–∞</span> ‚Äî –º–∞—Å—à—Ç–∞–± –∏ –≤—Ä–∞—â–µ–Ω–∏–µ</div>
        </div>
      </div>
    </div>
  </div>

  <a-scene
  mindar-image="imageTargetSrc: targets.mind; autoStart: true; uiScanning: false; uiLoading: false;"
  color-space="sRGB"
  background="transparent: true"
  renderer="alpha: true; colorManagement: true; physicallyCorrectLights: true;"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: true"
>
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity light="type: ambient; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="0 1 1"></a-entity>

    <a-entity id="markerRoot" mindar-image-target="targetIndex: 0">
      <a-entity
        id="object"
        gltf-model="url(model.glb)"
        position="0 0 0"
        rotation="0 0 0"
        scale="0.35 0.35 0.35"
      ></a-entity>

      <a-plane position="0 -0.001 0" rotation="-90 0 0" width="0.8" height="0.8"
               material="color: #ffffff; opacity: 0.08; transparent: true"></a-plane>
    </a-entity>
  </a-scene>

  <script>
    const ui = document.getElementById("ui");
    const chip = document.getElementById("chip");
    const dot = document.getElementById("dot");
    const markerRoot = document.getElementById("markerRoot");
    const obj = document.getElementById("object");

    // –°–æ–±—ã—Ç–∏—è MindAR: targetFound / targetLost :contentReference[oaicite:2]{index=2}
    markerRoot.addEventListener("targetFound", () => {
      chip.textContent = "–ú–∞—Ä–∫–µ—Ä —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω ‚úÖ";
      dot.classList.remove("bad");
      dot.classList.add("ok");
      ui.classList.add("found");
    });

    markerRoot.addEventListener("targetLost", () => {
      chip.textContent = "–ú–∞—Ä–∫–µ—Ä –ø–æ—Ç–µ—Ä—è–Ω‚Ä¶";
      dot.classList.remove("ok");
      dot.classList.add("bad");
      ui.classList.remove("found");
    });

    let mode = "none";
    let lastX = 0, lastY = 0;
    let startDist = 0;
    let startScale = 1;
    let startAngle = 0;
    let startRotY = 0;

    function dist(t1, t2) {
      const dx = t2.clientX - t1.clientX;
      const dy = t2.clientY - t1.clientY;
      return Math.hypot(dx, dy);
    }

    function angle(t1, t2) {
      const dx = t2.clientX - t1.clientX;
      const dy = t2.clientY - t1.clientY;
      return Math.atan2(dy, dx) * 180 / Math.PI;
    }

    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

    const MOVE_FACTOR = 0.0015;

    // –ß—É—Ç—å –Ω–∞–¥—ë–∂–Ω–µ–µ –¥–ª—è iOS: passive:false + preventDefault, —á—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –ø—ã—Ç–∞–ª–∞—Å—å —Å–∫—Ä–æ–ª–ª–∏—Ç—å—Å—è/–∑—É–º–∏—Ç—å—Å—è
    document.addEventListener("touchstart", (e) => {
      if (!obj) return;

      if (e.touches.length === 1) {
        mode = "drag";
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
      }

      if (e.touches.length === 2) {
        mode = "pinch";
        startDist = dist(e.touches[0], e.touches[1]);
        startScale = obj.object3D.scale.x;
        startAngle = angle(e.touches[0], e.touches[1]);
        startRotY = obj.object3D.rotation.y * 180 / Math.PI;
      }
    }, { passive: false });

    document.addEventListener("touchmove", (e) => {
      if (!obj) return;
      e.preventDefault();

      if (mode === "drag" && e.touches.length === 1) {
        const x = e.touches[0].clientX;
        const y = e.touches[0].clientY;

        const dx = x - lastX;
        const dy = y - lastY;

        obj.object3D.position.x += dx * MOVE_FACTOR;
        obj.object3D.position.z += dy * MOVE_FACTOR;

        lastX = x; lastY = y;
      }

      if (mode === "pinch" && e.touches.length === 2) {
        const d = dist(e.touches[0], e.touches[1]);
        const scale = clamp(startScale * (d / startDist), 0.1, 2.5);
        obj.object3D.scale.set(scale, scale, scale);

        const a = angle(e.touches[0], e.touches[1]);
        const delta = a - startAngle;
        const rotY = (startRotY + delta) * Math.PI / 180;
        obj.object3D.rotation.y = rotY;
      }
    }, { passive: false });

    document.addEventListener("touchend", (e) => {
      if (e.touches.length === 0) mode = "none";
      if (e.touches.length === 1) {
        mode = "drag";
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
      }
    }, { passive: false });
  </script>
</body>
</html>

